<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>2025 北海道冬の旅手帳 ❄️</title>

    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#FDFBF7">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        kawaii: {
                            base: '#FDFBF7', text: '#4A4036', primary: '#FF9EAA', secondary: '#89CFF0',
                            accent: '#FFD54F', green: '#A7D7C5', purple: '#D4C1EC', card: '#FFFFFF'
                        }
                    },
                    fontFamily: { sans: ['"Zen Maru Gothic"', 'sans-serif'] },
                    boxShadow: {
                        'soft': '0 4px 20px -2px rgba(255, 158, 170, 0.15)',
                        'card': '0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03)',
                        'glow': '0 0 15px rgba(255, 158, 170, 0.5)' 
                    },
                    animation: { 'bounce-slow': 'bounce 3s infinite' }
                }
            }
        }
    </script>
    <style>
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        body { background-color: #FDFBF7; background-image: radial-gradient(#E5E5E5 1px, transparent 1px); background-size: 20px 20px; color: #4A4036; -webkit-tap-highlight-color: transparent; min-height: 100vh; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .tab-content { display: none; opacity: 0; transform: translateY(10px); transition: opacity 0.3s ease, transform 0.3s ease; padding-bottom: 140px; }
        .tab-content.active { display: block; opacity: 1; transform: translateY(0); }
        .kawaii-card { background: white; border-radius: 24px; box-shadow: 0 4px 15px rgba(0,0,0,0.03); border: 2px solid #F0F0F0; transition: transform 0.2s; position: relative; overflow: hidden; }
        .timeline-line { position: absolute; left: 28px; top: 40px; bottom: 0; width: 4px; background: repeating-linear-gradient(to bottom, #E3F2FD 0, #E3F2FD 10px, transparent 10px, transparent 20px); z-index: 0; border-radius: 4px; }
        .event-details { max-height: 0; overflow: hidden; transition: max-height 0.4s cubic-bezier(0, 1, 0, 1), opacity 0.4s ease; opacity: 0; }
        .expanded .event-details { max-height: 1000px; opacity: 1; margin-top: 1rem; padding-top: 1rem; border-top: 2px dashed #F0F0F0; }
        .nav-bar-float { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-radius: 30px 30px 0 0; box-shadow: 0 -10px 40px rgba(0,0,0,0.05); border-top: 1px solid rgba(255,255,255,0.8); }
        .nav-item.active .icon-container { background-color: #FF9EAA; color: white; transform: translateY(-10px) scale(1.1); box-shadow: 0 6px 15px rgba(255, 158, 170, 0.4); }
        .snow-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 0; }
        .snowflake { position: absolute; color: #BDE0FE; font-size: 1rem; text-shadow: 0 0 5px rgba(255,255,255,0.8); animation: snow 15s linear infinite; }
        @keyframes snow { 0% { transform: translateY(-10px) translateX(0) rotate(0deg); opacity: 0; } 20% { opacity: 0.8; } 100% { transform: translateY(100vh) translateX(20px) rotate(360deg); opacity: 0.2; } }
    </style>
</head>
<body class="font-sans flex flex-col relative text-kawaii-text selection:bg-kawaii-primary selection:text-white">

    <div class="snow-container">
        <div class="snowflake" style="left: 10%; animation-delay: 0s;">❄</div>
        <div class="snowflake" style="left: 25%; animation-delay: 2s; font-size: 0.8rem;">❅</div>
        <div class="snowflake" style="left: 50%; animation-delay: 4s;">❄</div>
        <div class="snowflake" style="left: 75%; animation-delay: 1s; font-size: 1.2rem;">❅</div>
        <div class="snowflake" style="left: 90%; animation-delay: 3s;">❄</div>
    </div>

    <header class="sticky top-0 z-40 bg-white/80 backdrop-blur-md border-b border-white/50 shadow-sm transition-all duration-300">
        <div class="px-3 py-3 flex justify-between items-center max-w-2xl mx-auto gap-2">
            <div class="flex items-center gap-2 overflow-hidden">
                <div class="w-10 h-10 flex-shrink-0 bg-gradient-to-tr from-kawaii-secondary to-blue-50 rounded-2xl flex items-center justify-center shadow-inner text-xl relative overflow-hidden group">
                    <span class="group-hover:animate-bounce-slow inline-block">⛄</span>
                    <div class="absolute inset-0 bg-white/20 rounded-2xl"></div>
                </div>
                <div class="min-w-0">
                    <h1 class="text-base font-black tracking-wide text-gray-800 truncate leading-tight">
                        2025 北海道<br>冬の旅手帳
                    </h1>
                </div>
            </div>
            <a href="https://docs.google.com/document/d/1WI3KNDMLUYx4P_X6-Oxj5lBcrVkfZfUeL3ah2RJeojE/edit?usp=sharing" target="_blank" class="flex-shrink-0 flex items-center gap-1.5 bg-kawaii-primary text-white pl-3 pr-4 py-2 rounded-full font-bold text-xs shadow-md shadow-pink-200 hover:shadow-glow hover:scale-105 active:scale-95 transition-all">
                <i class="fas fa-file-alt"></i> <span>看完整行程</span>
            </a>
        </div>
    </header>

    <main class="w-full relative max-w-2xl mx-auto p-4 z-10 pb-32">
        <div id="tab-plan" class="tab-content active">
            <div id="date-scroll" class="flex overflow-x-auto gap-3 pb-4 mb-2 hide-scrollbar sticky top-[70px] z-30 py-2 -mx-4 px-4 bg-gradient-to-b from-kawaii-base via-kawaii-base to-transparent"></div>
            <div id="itinerary-container" class="space-y-6 relative pl-2 pr-2 mt-2"></div>
            <div class="text-center mt-12 mb-8"><p class="text-xs text-gray-300 font-bold">—— 每一天都是新的冒險 ——</p></div>
        </div>

        <div id="tab-guide" class="tab-content">
            <div class="flex items-center gap-3 mb-6">
                <h2 class="text-2xl font-black text-kawaii-text">旅行筆記</h2>
                <span class="bg-kawaii-accent/30 text-yellow-700 text-xs font-bold px-2 py-1 rounded-lg">豆知識</span>
            </div>
            <div id="guide-container" class="grid grid-cols-1 gap-5"></div>
        </div>

        <div id="tab-wallet" class="tab-content">
            <div class="bg-white rounded-[32px] p-6 shadow-soft mb-6 relative border-4 border-kawaii-primary/10">
                <div class="absolute top-4 right-6 text-kawaii-primary/20 text-6xl rotate-12"><i class="fas fa-coins"></i></div>
                
                <div class="relative z-10 flex gap-4 mb-4">
                    <div class="flex-1">
                        <label class="text-xs font-bold text-gray-400 mb-1 block tracking-wider">匯率 (Rate)</label>
                        <input type="number" id="exchange-rate" value="0.201" step="0.001" class="w-full text-2xl font-black bg-transparent border-b-2 border-kawaii-primary/30 focus:border-kawaii-primary focus:outline-none text-kawaii-text" placeholder="0.201">
                    </div>
                    <div class="w-20">
                        <label class="text-xs font-bold text-gray-400 mb-1 block tracking-wider">人數</label>
                        <div class="flex items-center">
                            <i class="fas fa-user text-kawaii-primary mr-1 text-xs"></i>
                            <input type="number" id="traveler-count" value="2" min="1" class="w-full text-2xl font-black bg-transparent border-b-2 border-kawaii-primary/30 focus:border-kawaii-primary focus:outline-none text-kawaii-text text-center" onchange="updateSplitCalc()">
                        </div>
                    </div>
                </div>

                <div class="bg-gray-50 rounded-2xl p-4 mb-4 border border-gray-100 shadow-inner">
                    <input type="text" id="calc-input" placeholder="0" class="w-full bg-transparent text-2xl text-right focus:outline-none mb-1 font-black text-kawaii-text font-mono tracking-widest">
                    <div class="flex justify-between items-end border-t border-dashed border-gray-200 pt-2">
                        <span class="text-xs text-gray-400 font-bold">JPY</span>
                        <div class="text-right">
                            <span class="text-xs text-gray-400 font-bold mr-1">約 TWD</span>
                            <span id="calc-result-twd" class="text-lg font-bold text-kawaii-secondary">0</span>
                        </div>
                    </div>
                    <span id="calc-result-jpy" class="hidden">0</span>
                </div>

                <div class="grid grid-cols-4 gap-3 mb-4">
                    <button onclick="appendCalc('+')" class="h-10 rounded-xl bg-gray-50 font-bold text-gray-400 hover:bg-gray-100">+</button>
                    <button onclick="appendCalc('-')" class="h-10 rounded-xl bg-gray-50 font-bold text-gray-400 hover:bg-gray-100">-</button>
                    <button onclick="appendCalc('*')" class="h-10 rounded-xl bg-gray-50 font-bold text-gray-400 hover:bg-gray-100">×</button>
                    <button onclick="appendCalc('/')" class="h-10 rounded-xl bg-gray-50 font-bold text-gray-400 hover:bg-gray-100">÷</button>
                    
                    <button onclick="appendCalc('7')" class="h-12 rounded-2xl bg-white shadow-card font-black text-lg text-kawaii-text active:scale-95 transition-transform">7</button>
                    <button onclick="appendCalc('8')" class="h-12 rounded-2xl bg-white shadow-card font-black text-lg text-kawaii-text active:scale-95 transition-transform">8</button>
                    <button onclick="appendCalc('9')" class="h-12 rounded-2xl bg-white shadow-card font-black text-lg text-kawaii-text active:scale-95 transition-transform">9</button>
                    <button onclick="clearCalc()" class="h-12 rounded-2xl bg-red-50 text-red-400 font-black text-lg active:scale-95 transition-transform">C</button>
                    <button onclick="appendCalc('4')" class="h-12 rounded-2xl bg-white shadow-card font-black text-lg text-kawaii-text active:scale-95 transition-transform">4</button>
                    <button onclick="appendCalc('5')" class="h-12 rounded-2xl bg-white shadow-card font-black text-lg text-kawaii-text active:scale-95 transition-transform">5</button>
                    <button onclick="appendCalc('6')" class="h-12 rounded-2xl bg-white shadow-card font-black text-lg text-kawaii-text active:scale-95 transition-transform">6</button>
                    <button onclick="calculate()" class="h-12 rounded-2xl bg-kawaii-secondary text-white font-black text-lg shadow-lg shadow-blue-200 active:scale-95 transition-transform">=</button>
                    <button onclick="appendCalc('1')" class="h-12 rounded-2xl bg-white shadow-card font-black text-lg text-kawaii-text active:scale-95 transition-transform">1</button>
                    <button onclick="appendCalc('2')" class="h-12 rounded-2xl bg-white shadow-card font-black text-lg text-kawaii-text active:scale-95 transition-transform">2</button>
                    <button onclick="appendCalc('3')" class="h-12 rounded-2xl bg-white shadow-card font-black text-lg text-kawaii-text active:scale-95 transition-transform">3</button>
                    <button onclick="appendCalc('0')" class="h-12 rounded-2xl bg-white shadow-card font-black text-lg text-kawaii-text active:scale-95 transition-transform">0</button>
                </div>

                <div class="border-t border-dashed border-gray-200 pt-4 flex gap-3">
                    <input type="text" id="expense-item" placeholder="買了什麼呢..." class="flex-1 bg-gray-50 rounded-xl px-4 py-2 text-sm font-bold outline-none border border-transparent focus:border-kawaii-primary/50 transition-colors">
                    <label class="w-10 h-10 flex items-center justify-center bg-kawaii-accent rounded-xl text-white cursor-pointer shadow-md active:scale-95 transition-transform">
                        <i class="fas fa-camera"></i>
                        <input type="file" id="expense-photo" accept="image/*" class="hidden" onchange="handlePhotoUpload(this)">
                    </label>
                </div>
                
                <div class="mt-2 flex items-center justify-end gap-2 pr-1">
                    <label class="flex items-center gap-2 cursor-pointer select-none group">
                        <input type="checkbox" id="expense-is-advance" class="peer hidden">
                        <div class="w-4 h-4 rounded border-2 border-gray-300 peer-checked:bg-kawaii-secondary peer-checked:border-kawaii-secondary flex items-center justify-center transition-all bg-white group-active:scale-95">
                            <i class="fas fa-check text-white text-[10px] opacity-0 peer-checked:opacity-100"></i>
                        </div>
                        <span class="text-xs font-bold text-gray-400 peer-checked:text-kawaii-secondary transition-colors">幫別人代墊 (事後算)</span>
                    </label>
                </div>
                
                <div id="photo-preview-container" class="hidden mt-3 relative w-full h-32 bg-gray-100 rounded-xl overflow-hidden border-2 border-white shadow-sm">
                    <img id="photo-preview" class="w-full h-full object-contain">
                    <button onclick="clearPhoto()" class="absolute top-2 right-2 bg-red-400 text-white w-6 h-6 rounded-full flex items-center justify-center font-bold shadow-md">×</button>
                </div>

                <button onclick="addExpense()" class="w-full bg-kawaii-primary text-white py-3 rounded-2xl shadow-lg shadow-pink-200 mt-4 font-black tracking-wide active:scale-[0.98] transition-all flex items-center justify-center gap-2">
                    <i class="fas fa-plus-circle"></i> 記下來
                </button>
            </div>

            <div class="px-2">
                <div class="bg-gradient-to-r from-pink-50 to-white p-4 rounded-2xl border border-pink-100 shadow-sm mb-6 flex justify-between items-center relative overflow-hidden">
                    <div class="absolute -right-4 -top-4 w-16 h-16 bg-pink-200 rounded-full opacity-30 blur-xl"></div>
                    <div>
                        <div class="text-[10px] font-bold text-gray-400 mb-1">代墊總額 (Advance Total)</div>
                        <div class="text-xl font-black text-gray-700">¥<span id="advance-total">0</span></div>
                    </div>
                    <div class="text-right z-10">
                        <div class="text-[10px] font-bold text-kawaii-primary mb-1">每人應付 (Per Person)</div>
                        <div class="text-2xl font-black text-kawaii-primary">¥<span id="split-result">0</span></div>
                    </div>
                </div>

                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-black text-lg text-kawaii-text">支出紀錄</h3>
                    <span class="text-xs font-bold bg-white px-3 py-1 rounded-full shadow-sm text-gray-500">Total: <span class="text-kawaii-primary">¥</span><span id="total-jpy">0</span></span>
                </div>

                <div class="flex gap-2 mb-2">
                    <button onclick="syncToCloud()" id="btn-upload" class="flex-1 bg-blue-400 text-white py-2 rounded-xl font-bold text-xs shadow-md active:scale-95 transition-all flex items-center justify-center gap-1">
                        <i class="fas fa-cloud-upload-alt"></i> 備份到雲端
                    </button>
                    <button onclick="syncFromCloud()" id="btn-download" class="flex-1 bg-gray-400 text-white py-2 rounded-xl font-bold text-xs shadow-md active:scale-95 transition-all flex items-center justify-center gap-1">
                        <i class="fas fa-cloud-download-alt"></i> 從雲端還原
                    </button>
                </div>
                <div class="text-[10px] text-center text-gray-300 mb-2 font-mono">
                    Device ID: <span id="my-device-id">loading...</span>
                </div>
                <div id="sync-status" class="text-[10px] text-center text-gray-400 mb-4 h-4 font-bold transition-all"></div>

                <div id="expense-container" class="space-y-6 pb-8"></div>
                <button onclick="clearExpenses()" class="w-full text-center text-xs text-gray-300 mt-2 hover:text-red-300 transition-colors">🗑️ 清空所有紀錄</button>
            </div>
        </div>

        <div id="tab-lists" class="tab-content px-1">
            <div class="bg-white rounded-[32px] p-6 shadow-soft mb-6 relative">
                <div class="w-12 h-12 bg-kawaii-green/20 rounded-full flex items-center justify-center text-kawaii-green text-xl absolute -top-4 -left-2 shadow-sm border-4 border-kawaii-base"><i class="fas fa-suitcase-rolling"></i></div>
                <h3 class="text-lg font-black mb-4 pl-10 text-kawaii-text">行李檢查表</h3>
                <div id="checklist-container" class="space-y-3"></div>
                <div class="mt-6 flex gap-3 relative">
                    <input type="text" id="new-todo" placeholder="新增項目..." class="flex-1 bg-gray-50 rounded-full px-4 text-sm font-bold outline-none border-2 border-transparent focus:border-kawaii-green/50 transition-colors h-10">
                    <button onclick="addTodo()" class="bg-kawaii-green text-white w-10 h-10 rounded-full shadow-md hover:shadow-lg active:scale-90 transition-all flex items-center justify-center"><i class="fas fa-plus"></i></button>
                </div>
            </div>
            <div class="bg-[#FFFDF0] rounded-[32px] p-6 shadow-card relative border-2 border-[#FEF9E7]">
                <div class="absolute -top-3 -right-2 text-2xl rotate-12">📝</div>
                <h3 class="text-lg font-black mb-2 text-[#C9B36B]">隨手記</h3>
                <textarea id="memo-area" class="w-full h-40 bg-transparent p-2 text-sm leading-8 outline-none resize-none font-bold text-[#8D7F57] placeholder-[#D8CFB4]" style="background-image: repeating-linear-gradient(transparent, transparent 31px, #EBE3CC 31px, #EBE3CC 32px); line-height: 32px;" placeholder="這裡可以貼連結或寫日記..."></textarea>
            </div>
        </div>

        <div id="tab-info" class="tab-content space-y-5">
             <div class="bg-white rounded-3xl p-5 shadow-soft border border-gray-50">
                <div class="flex items-center gap-3 mb-4"><span class="w-8 h-8 rounded-full bg-kawaii-primary/20 flex items-center justify-center text-kawaii-primary text-xs"><i class="fas fa-bed"></i></span><h3 class="font-black text-lg text-kawaii-text">住宿資訊</h3></div>
                <div class="pl-2 border-l-4 border-kawaii-primary/30 ml-2"><h4 class="text-base font-black text-kawaii-text">Hotel Vista Sapporo Odori</h4><p class="text-xs text-gray-400 font-bold">ホテルビスタ札幌 [大通]</p></div>
                <div class="mt-4 space-y-2 text-sm font-medium text-gray-600 bg-gray-50 p-4 rounded-2xl">
                    <div class="flex items-start gap-3"><i class="fas fa-map-marker-alt mt-1 text-kawaii-primary"></i><p class="text-xs leading-relaxed">〒060-0063<br>北海道札幌市中央区南3条西5丁目16<br><span class="text-gray-400">(狸小路 5丁目附近)</span></p></div>
                </div>
                <a href="https://www.google.com/maps/search/?api=1&query=Hotel+Vista+Sapporo+Odori" target="_blank" class="mt-4 flex items-center justify-center w-full bg-white border-2 border-gray-100 text-kawaii-text py-2.5 rounded-xl font-bold text-xs shadow-sm hover:border-kawaii-primary/50 transition-colors"><i class="fas fa-location-arrow mr-2 text-kawaii-primary"></i> 開啟地圖</a>
            </div>
            <div class="bg-gradient-to-br from-[#E0F7FA] to-white rounded-3xl p-5 shadow-soft relative overflow-hidden">
                <div class="absolute -right-5 -top-5 w-20 h-20 bg-blue-100 rounded-full opacity-50 blur-xl"></div>
                <h3 class="font-black text-lg mb-4 flex items-center gap-2 relative z-10 text-cyan-800"><i class="fas fa-flag text-cyan-400"></i> 一日遊集合</h3>
                <div class="bg-white/80 backdrop-blur-sm p-4 rounded-2xl border border-white mb-3 shadow-sm">
                    <div class="flex justify-between items-start"><span class="bg-cyan-100 text-cyan-700 text-[10px] font-black px-2 py-1 rounded-md">12/22 登別洞爺</span><a href="https://www.google.com/maps/search/?api=1&query=%E5%A4%A7%E9%80%9A%E5%85%AC%E5%9C%92+%E5%B8%8C%E6%9C%9B%E3%81%AE%E5%83%8F" target="_blank" class="text-cyan-400"><i class="fas fa-map-pin"></i></a></div>
                    <div class="mt-2"><div class="text-2xl font-black text-kawaii-text">08:00 <span class="text-xs font-normal text-gray-400">集合</span></div><div class="text-sm font-bold text-gray-600">大通公園 希望之像</div></div>
                </div>
                <div class="bg-white/80 backdrop-blur-sm p-4 rounded-2xl border border-white shadow-sm">
                    <div class="flex justify-between items-start"><span class="bg-blue-100 text-blue-700 text-[10px] font-black px-2 py-1 rounded-md">12/23 旭川美瑛</span><a href="https://www.google.com/maps/search/?api=1&query=%E6%9C%AD%E5%B9%8C%E9%A7%85%E5%8C%97%E5%8F%A3%E5%9B%A3%E4%BD%93%E3%83%90%E3%82%B9%E4%B9%97%E3%82%8A%E5%A0%B4" target="_blank" class="text-blue-400"><i class="fas fa-map-pin"></i></a></div>
                    <div class="mt-2"><div class="text-2xl font-black text-kawaii-text">07:50 <span class="text-xs font-normal text-gray-400">集合</span></div><div class="text-sm font-bold text-gray-600">札幌站 北口巴士站</div></div>
                </div>
            </div>
            <div class="bg-white rounded-3xl p-5 shadow-soft border-l-8 border-red-200">
                 <h3 class="font-black text-lg mb-3">SOS 緊急聯絡</h3>
                 <div class="grid grid-cols-2 gap-3">
                     <a href="tel:110" class="bg-red-50 p-3 rounded-xl flex flex-col items-center justify-center gap-1 active:scale-95 transition-transform"><i class="fas fa-user-shield text-red-400 text-xl"></i><span class="text-xs font-black text-red-400">警察 110</span></a>
                     <a href="tel:119" class="bg-red-50 p-3 rounded-xl flex flex-col items-center justify-center gap-1 active:scale-95 transition-transform"><i class="fas fa-ambulance text-red-400 text-xl"></i><span class="text-xs font-black text-red-400">救護 119</span></a>
                 </div>
                 <div class="mt-3 bg-gray-50 rounded-xl p-3 text-center"><div class="text-[10px] text-gray-400 mb-1">駐日經濟文化代表處</div><a href="tel:+81112222930" class="font-black text-gray-700">+81-11-222-2930</a></div>
            </div>
        </div>
    </main>

    <nav class="nav-bar-float fixed bottom-0 left-0 w-full pb-safe z-50">
        <div class="flex justify-around items-end h-20 px-2">
            <button class="nav-item active w-full h-full pb-2 flex flex-col items-center justify-end transition-all duration-300 group" onclick="switchTab('plan', this)">
                <div class="icon-container w-10 h-10 rounded-2xl flex items-center justify-center mb-1 transition-all duration-300 bg-transparent text-gray-400"><i class="fas fa-map-marked-alt text-lg"></i></div>
                <span class="text-[10px] font-bold text-gray-400 group-[.active]:text-kawaii-primary transition-colors">行程</span>
            </button>
            <button class="nav-item w-full h-full pb-2 flex flex-col items-center justify-end transition-all duration-300 group" onclick="switchTab('guide', this)">
                <div class="icon-container w-10 h-10 rounded-2xl flex items-center justify-center mb-1 transition-all duration-300 bg-transparent text-gray-400"><i class="fas fa-book-open text-lg"></i></div>
                <span class="text-[10px] font-bold text-gray-400 group-[.active]:text-kawaii-primary transition-colors">導覽</span>
            </button>
            <button class="nav-item w-full h-full pb-2 flex flex-col items-center justify-end transition-all duration-300 group" onclick="switchTab('wallet', this)">
                <div class="icon-container w-12 h-12 rounded-[20px] flex items-center justify-center mb-1 transition-all duration-300 bg-transparent text-gray-400 -mt-4 group-[.active]:-mt-6"><i class="fas fa-wallet text-xl"></i></div>
                <span class="text-[10px] font-bold text-gray-400 group-[.active]:text-kawaii-primary transition-colors">錢包</span>
            </button>
            <button class="nav-item w-full h-full pb-2 flex flex-col items-center justify-end transition-all duration-300 group" onclick="switchTab('lists', this)">
                <div class="icon-container w-10 h-10 rounded-2xl flex items-center justify-center mb-1 transition-all duration-300 bg-transparent text-gray-400"><i class="fas fa-tasks text-lg"></i></div>
                <span class="text-[10px] font-bold text-gray-400 group-[.active]:text-kawaii-primary transition-colors">清單</span>
            </button>
            <button class="nav-item w-full h-full pb-2 flex flex-col items-center justify-end transition-all duration-300 group" onclick="switchTab('info', this)">
                <div class="icon-container w-10 h-10 rounded-2xl flex items-center justify-center mb-1 transition-all duration-300 bg-transparent text-gray-400"><i class="fas fa-info-circle text-lg"></i></div>
                <span class="text-[10px] font-bold text-gray-400 group-[.active]:text-kawaii-primary transition-colors">資訊</span>
            </button>
        </div>
    </nav>

    <script>
        // 資料與邏輯部分
        
        // ★★★ 關鍵修正：將變數宣告移到最上方，確保全域可存取 ★★★
        let currentPhotoBase64 = null;
        let expenses = JSON.parse(localStorage.getItem('expenses_book_2025_v13')) || [];
        let todoList = JSON.parse(localStorage.getItem('todo_book_2025_v7')) || [
            { text: "護照 (效期6個月以上) 📕", done: false },
            { text: "Visit Japan Web (截圖備用) 📱", done: false },
            { text: "旅遊保險 (平安險+不便險) 📄", done: false },
            { text: "eSIM / 漫遊設定完成 📶", done: false },
            { text: "日幣現金 & 信用卡 (JCB/Visa) 💴", done: false },
            { text: "交通卡 (Suica/ICOCA) 🐧", done: false },
            { text: "防滑雪靴 & 防水手套 🧤", done: false },
            { text: "防寒衣物 (發熱衣/毛帽/圍巾) 🧣", done: false },
            { text: "個人盥洗 (牙刷/牙膏) 🪥", done: false },
            { text: "充電器 & 行動電源 (低溫耗電快) 🔋", done: false },
            { text: "常備藥 (感冒/暈車/外傷/止痛) 💊", done: false }
        ];

        const itineraryData = [
            {
                date: "12/20", day: "六", title: "前進雪國 ✈️", active: true,
                weather: { icon: "fa-snowflake", temp: "-2°", desc: "大雪" },
                events: [
                    { time: "09:10", desc: "桃園機場 (T1)", type: "transport", note: "提早3hr!", highlight: true, details: "09:10前抵達。酷航櫃台人多，請提早。填寫 Visit Japan Web。" },
                    { time: "12:10", desc: "酷航 TR892", type: "transport", details: "12:10 起飛 -> 17:20 抵達新千歲 (CTS)。" },
                    { time: "17:50", desc: "抵達新千歲", type: "transport", details: "搭乘 JR 快速 Airport (¥1,150) 前往札幌。" },
                    { time: "19:00", desc: "旅館 Check-in", type: "stay", mapLink: "https://www.google.com/maps/search/?api=1&query=Hotel+Vista+Sapporo+Odori", details: "Hotel Vista Sapporo Odori。狸小路商店街附近。" },
                    { time: "19:30", desc: "湯咖哩 Suage+", type: "food", note: "必吃!", details: "推薦：串燒湯咖哩。飯泡湯吃。" },
                    { time: "20:30", desc: "夜間聖代", type: "activity", details: "推薦：ななかま堂。之後逛唐吉軻德。" }
                ]
            },
            {
                date: "12/21", day: "日", title: "札幌市區巡禮 ⛩️", active: false,
                weather: { icon: "fa-cloud-meatball", temp: "-3°", desc: "多雲雪" },
                events: [
                    { time: "08:30", desc: "諏訪神社", type: "spot", details: "必買超可愛「銀喉長尾山雀」御守！" },
                    { time: "09:30", desc: "北海道大學", type: "spot", details: "必去 Marche Café 吃農場冰淇淋。" },
                    { time: "12:00", desc: "叙々苑燒肉 🔥", type: "food", highlight: true, note: "預約12:00", details: "高級燒肉午間套餐 CP 值高。" },
                    { time: "13:30", desc: "紅磚廳舍 & 北菓樓", type: "walk", details: "必拍紅磚建築。北菓樓本館(安藤忠雄設計)必吃「夢不思議」大泡芙！" },
                    { time: "14:30", desc: "時計台 & 札幌工廠", type: "walk", details: "路過拍時計台。札幌工廠有巨大聖誕樹(室內)，氣氛超棒！" },
                    { time: "16:00", desc: "百貨商場 & 狸小路", type: "shop", details: "推薦：大丸(寶可夢中心)、Stellar Place(年輕時尚)、Parco。最後去狸小路掃藥妝。" },
                    { time: "17:00", desc: "COCONO SUSUKINO", type: "shop", details: "薄野新地標。晚餐吃根室花丸。" },
                    { time: "19:00", desc: "聖誕市集", type: "spot", details: "大通公園慕尼黑聖誕市集。" }
                ]
            },
            {
                date: "12/22", day: "一", title: "登別洞爺一日遊 🚌", active: false,
                weather: { icon: "fa-cloud-sun", temp: "-1°", desc: "晴時雲" },
                events: [
                    { time: "07:40", desc: "集合：大通公園", type: "transport", highlight: true, note: "西3丁目", details: "08:00 準時發車。大通公園西3丁目（31號出口）。" },
                    { time: "09:50", desc: "登別地獄谷 ♨️", type: "spot", details: "火山地形，走路小心。" },
                    { time: "11:50", desc: "熊牧場 🐻", type: "spot", details: "可以餵熊吃蘋果。" },
                    { time: "13:40", desc: "洞爺湖", type: "spot", details: "欣賞湖光山色。" },
                    { time: "19:00", desc: "JR塔夜景", type: "spot", details: "T38 展望台看夜景。" }
                ]
            },
            {
                date: "12/23", day: "二", title: "旭川美瑛夢幻遊 🐧", active: false,
                weather: { icon: "fa-snowflake", temp: "-6°", desc: "大雪" },
                events: [
                    { time: "07:50", desc: "集合：札幌北口", type: "transport", highlight: true, details: "札幌站北口巴士停車場。" },
                    { time: "10:30", desc: "旭山動物園", type: "spot", details: "11:00 企鵝散步！" },
                    { time: "13:10", desc: "美瑛青池", type: "spot", details: "冬季結冰點燈的青池。" },
                    { time: "15:00", desc: "精靈露台", type: "spot", details: "像童話世界一樣的小木屋。" },
                    { time: "19:30", desc: "帝王蟹吃到飽 🦀", type: "food", highlight: true, note: "蟹座", details: "大口吃螃蟹！" }
                ]
            },
            {
                date: "12/24", day: "三", title: "白色聖誕夜 🎄", active: false,
                weather: { icon: "fa-snowflake", temp: "-2°", desc: "飄雪" },
                events: [
                    { time: "08:30", desc: "羊之丘展望台", type: "activity", details: "免費體驗玩雪。" },
                    { time: "12:00", desc: "拉麵橫丁", type: "food", details: "推薦：弟子屈拉麵。" },
                    { time: "14:00", desc: "北海道神宮", type: "spot", details: "必吃六花亭判官大人麻糬。" },
                    { time: "16:00", desc: "白色戀人公園", type: "spot", note: "聖誕點燈", details: "歐風庭園非常漂亮。" },
                    { time: "18:30", desc: "爐端燒晚餐", type: "food", highlight: true, details: "Kakureya 氣氛滿分。" },
                    { time: "20:30", desc: "AOAO 水族館", type: "spot", details: "moyuk 商場內。" }
                ]
            },
            {
                date: "12/25", day: "四", title: "小樽浪漫漫步 🕯️", active: false,
                weather: { icon: "fa-cloud", temp: "-3°", desc: "陰天" },
                events: [
                    { time: "09:10", desc: "前往小樽", type: "transport", details: "搭乘 JR 快速 Airport。" },
                    { time: "10:00", desc: "小樽運河", type: "walk", details: "北菓樓、LeTAO、音樂盒堂。" },
                    { time: "12:00", desc: "若雞時代", type: "food", details: "必吃炸半雞定食！" },
                    { time: "16:00", desc: "藻岩山夜景", type: "spot", details: "新日本三大夜景。" },
                    { time: "19:00", desc: "最後採買", type: "shop", details: "把日幣花光光！" }
                ]
            },
            {
                date: "12/26", day: "五", title: "再見北海道 👋", active: false,
                weather: { icon: "fa-sun", temp: "-1°", desc: "晴天" },
                events: [
                    { time: "08:30", desc: "前往機場", type: "transport", details: "搭巴士或 JR。建議 12:20 到機場。" },
                    { time: "10:50", desc: "機場逛街", type: "shop", details: "哆啦A夢空中樂園、Royce。" },
                    { time: "12:00", desc: "一幻拉麵", type: "food", details: "超濃郁蝦湯。" },
                    { time: "15:20", desc: "長榮 BR115", type: "transport", highlight: true, note: "回台北", details: "平安回家。" }
                ]
            }
        ];

        const guideData = [
            { title: "小樽堺町通り商店街", content: "充滿懷舊風情的必逛街道！這條街上有著名的「小樽音樂盒堂」、「北一硝子」玻璃工坊，還有超好吃的「LeTAO」起司蛋糕總店。想買伴手禮來這裡準沒錯！", tags: ["購物", "散步", "小樽"] },
            { title: "大丸札幌店 (Daimaru)", content: "與札幌車站直結，非常好逛！8樓有必去的「Pokémon Center Sapporo (寶可夢中心)」，B1 地下食品街 (Depachika) 更是美食天堂，各種甜點便當應有盡有。", tags: ["寶可夢", "美食", "伴手禮"] },
            { title: "狸小路商店街", content: "札幌最經典的商店街，從1丁目到7丁目都有屋頂，下大雪也不怕！藥妝店(如松本清、札幌藥妝)、唐吉軻德都在這裡，是掃貨的聖地。", tags: ["藥妝", "必逛", "雨備"] },
            { title: "札幌工廠 (Sapporo Factory)", content: "由紅磚啤酒廠改建的購物中心，保留了巨大的煙囪。中庭 (Atrium) 非常挑高寬敞，冬季會有巨大的室內聖誕樹，氣氛超級浪漫！", tags: ["紅磚", "拍照", "室內"] },
            { title: "白色戀人公園", content: "不只是賣餅乾，更像一座雪國城堡！冬季庭園有盛大點燈，一定要在戶外愛心拱門拍照。", tags: ["浪漫", "必去"] },
            { title: "企鵝散步", content: "旭山動物園冬季限定！看著國王企鵝搖搖晃晃走在雪道上，萌翻天。", tags: ["動物", "限定"] },
            { title: "小樽運河", content: "黃昏時分煤氣燈亮起是最浪漫的時刻。站在「淺草橋」上可以拍到最經典角度。", tags: ["拍照", "夜景"] },
            { title: "收尾聖代", content: "札幌文化：喝酒後吃「聖代」做結尾！口感層次豐富，是大人的甜點。", tags: ["美食", "文化"] },
            { title: "精靈露台", content: "富良野森林裡的小木屋，點燈後像精靈居住的夢幻國度。", tags: ["夢幻", "手作"] }
        ];

        // 核心邏輯
        function getDeviceId() {
            let id = localStorage.getItem('my_device_id');
            if (!id) {
                id = 'user_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('my_device_id', id);
            }
            return id;
        }

        window.onload = function () {
            renderPlanTabs();
            renderTimeline(0);
            renderGuide();
            renderExpenses();
            renderTodoList();
            
            document.getElementById('my-device-id').innerText = getDeviceId();

            const savedCount = localStorage.getItem('traveler_count_v11');
            if (savedCount) document.getElementById('traveler-count').value = savedCount;
            updateSplitCalc();

            const savedMemo = localStorage.getItem('memo_book_2025_v1');
            if (savedMemo) document.getElementById('memo-area').value = savedMemo;

            document.getElementById('memo-area').addEventListener('input', function() {
                localStorage.setItem('memo_book_2025_v1', this.value);
            });

            document.getElementById('exchange-rate').addEventListener('input', calculate);
            document.getElementById('calc-input').addEventListener('input', calculate);
        };

        function switchTab(tabId, btn) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.getElementById('tab-' + tabId).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            btn.classList.add('active');
            window.scrollTo(0, 0);
        }
        function renderPlanTabs() {
            const container = document.getElementById('date-scroll');
            container.innerHTML = '';
            itineraryData.forEach((item, index) => {
                const btn = document.createElement('button');
                const isActive = index === 0;
                btn.className = `flex-shrink-0 w-[4.5rem] py-2 text-center transition-all rounded-full flex flex-col items-center justify-center gap-0.5 group ${isActive ? 'bg-kawaii-primary text-white shadow-lg shadow-pink-200 scale-105' : 'bg-white text-gray-400 border border-gray-100'}`;
                btn.innerHTML = `<span class="text-[10px] font-bold opacity-80">${item.date}</span><span class="text-base font-black">${item.day}</span>`;
                btn.onclick = () => {
                    Array.from(container.children).forEach(c => {
                        c.className = 'flex-shrink-0 w-[4.5rem] py-2 text-center transition-all rounded-full flex flex-col items-center justify-center gap-0.5 group bg-white text-gray-400 border border-gray-100';
                    });
                    btn.className = 'flex-shrink-0 w-[4.5rem] py-2 text-center transition-all rounded-full flex flex-col items-center justify-center gap-0.5 group bg-kawaii-primary text-white shadow-lg shadow-pink-200 scale-105';
                    renderTimeline(index);
                };
                container.appendChild(btn);
            });
        }
        function renderTimeline(index) {
            const dayData = itineraryData[index];
            const container = document.getElementById('itinerary-container');
            let html = `<div class="timeline-line"></div>`;
            html += `<div class="mb-6 ml-10"><div class="flex justify-between items-center pr-2"><h2 class="text-2xl font-black text-kawaii-text tracking-wide">${dayData.title}</h2><div class="flex flex-col items-center bg-white px-3 py-1.5 rounded-2xl shadow-sm border border-gray-50"><i class="fas ${dayData.weather.icon} text-kawaii-secondary text-lg mb-1"></i><span class="text-xs font-bold text-gray-400">${dayData.weather.temp}</span></div></div></div>`;
            dayData.events.forEach((event, idx) => {
                const hasDetails = event.details ? true : false;
                const eventId = `event-${idx}`;
                let iconClass = 'fa-circle'; let iconColor = 'text-gray-300'; let circleBg = 'bg-white'; let circleBorder = 'border-gray-200';
                if (event.type === 'transport') { iconClass = 'fa-train'; iconColor = 'text-white'; circleBg = 'bg-kawaii-secondary'; circleBorder = 'border-kawaii-secondary'; }
                else if (event.type === 'food') { iconClass = 'fa-utensils'; iconColor = 'text-white'; circleBg = 'bg-kawaii-primary'; circleBorder = 'border-kawaii-primary'; }
                else if (event.type === 'stay') { iconClass = 'fa-bed'; iconColor = 'text-white'; circleBg = 'bg-kawaii-purple'; circleBorder = 'border-kawaii-purple'; }
                else if (event.type === 'spot') { iconClass = 'fa-camera'; iconColor = 'text-white'; circleBg = 'bg-kawaii-green'; circleBorder = 'border-kawaii-green'; }
                else if (event.type === 'shop') { iconClass = 'fa-shopping-bag'; iconColor = 'text-white'; circleBg = 'bg-kawaii-accent'; circleBorder = 'border-kawaii-accent'; }
                else if (event.type === 'walk') { iconClass = 'fa-walking'; iconColor = 'text-white'; circleBg = 'bg-orange-300'; circleBorder = 'border-orange-300'; }
                html += `<div class="relative pl-10 pb-5 z-10 group"><div class="absolute left-[18px] top-4 w-6 h-6 ${circleBg} ${circleBorder} border-2 rounded-full flex items-center justify-center z-20 shadow-md transform transition-transform group-hover:scale-110"><i class="fas ${iconClass} ${iconColor} text-[10px]"></i></div><div class="kawaii-card p-4 bg-white relative cursor-pointer active:scale-[0.98]" onclick="${hasDetails ? `toggleDetails('${eventId}', this)` : ''}">${event.highlight ? '<div class="absolute top-0 right-0 bg-kawaii-accent text-white text-[10px] font-black px-3 py-1 rounded-bl-xl rounded-tr-lg shadow-sm">IMPORTANT</div>' : ''}<div class="flex items-baseline gap-3 mb-1"><span class="font-black text-xl text-kawaii-text font-mono opacity-80">${event.time}</span></div><h4 class="text-base font-bold text-gray-700 mb-1 leading-snug">${event.desc}</h4>${event.note ? `<p class="text-xs text-kawaii-primary font-bold flex items-center gap-1"><i class="fas fa-star"></i> ${event.note}</p>` : ''}${hasDetails ? `<div id="${eventId}" class="event-details text-sm text-gray-500"><p class="mb-3 leading-relaxed bg-gray-50 p-3 rounded-xl">${event.details}</p><div class="flex gap-2">${event.mapLink ? `<a href="${event.mapLink}" target="_blank" class="px-3 py-1 bg-blue-50 text-blue-400 rounded-full text-xs font-bold hover:bg-blue-100 transition-colors" onclick="event.stopPropagation()">📍 地圖</a>` : ''}</div></div><div class="absolute bottom-2 right-3 opacity-20 text-gray-400 expand-icon transition-transform duration-300"><i class="fas fa-chevron-down"></i></div>` : ''}</div></div>`;
            });
            container.innerHTML = html;
        }
        function toggleDetails(id, card) { const details = document.getElementById(id); if (!details) return; card.classList.toggle('expanded'); const icon = card.querySelector('.expand-icon'); if (icon) icon.style.transform = card.classList.contains('expanded') ? 'rotate(180deg)' : 'rotate(0)'; }
        function renderGuide() {
            const container = document.getElementById('guide-container');
            let html = '';
            guideData.forEach((item, index) => {
                const colors = ['bg-red-50', 'bg-blue-50', 'bg-green-50', 'bg-purple-50', 'bg-yellow-50'];
                const color = colors[index % colors.length];
                html += `<div class="kawaii-card p-5 ${color} border-none"><div class="flex gap-2 mb-3">${item.tags.map(t => `<span class="text-[10px] font-bold bg-white/60 text-gray-500 px-2 py-1 rounded-full backdrop-blur-sm">#${t}</span>`).join('')}</div><h3 class="text-lg font-black text-gray-700 mb-2">${item.title}</h3><p class="text-sm text-gray-600 leading-relaxed font-medium">${item.content}</p></div>`;
            });
            container.innerHTML = html;
        }
        function appendCalc(val) { document.getElementById('calc-input').value += val; calculate(); }
        function clearCalc() { document.getElementById('calc-input').value = ""; calculate(); }
        function calculate() {
            const input = document.getElementById('calc-input').value;
            const rate = parseFloat(document.getElementById('exchange-rate').value) || 0.201;
            if(input.trim() === "") { document.getElementById('calc-result-twd').innerText = "0"; document.getElementById('calc-result-jpy').innerText = "0"; return; }
            try { if (/^[0-9+\-*/().\s]+$/.test(input)) { const jpy = new Function('return ' + input)(); if (isFinite(jpy)) { document.getElementById('calc-result-jpy').innerText = Math.round(jpy); document.getElementById('calc-result-twd').innerText = Math.round(jpy * rate).toLocaleString(); } } } catch (e) {}
        }
        function handlePhotoUpload(input) { if (input.files && input.files[0]) { const reader = new FileReader(); reader.onload = function (e) { const img = new Image(); img.onload = function () { const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d'); const maxSize = 300; let width = img.width; let height = img.height; if (width > height) { if (width > maxSize) { height *= maxSize / width; width = maxSize; } } else { if (height > maxSize) { width *= maxSize / height; height = maxSize; } } canvas.width = width; canvas.height = height; ctx.drawImage(img, 0, 0, width, height); currentPhotoBase64 = canvas.toDataURL('image/jpeg', 0.6); document.getElementById('photo-preview').src = currentPhotoBase64; document.getElementById('photo-preview-container').classList.remove('hidden'); }; img.src = e.target.result; }; reader.readAsDataURL(input.files[0]); } }
        function clearPhoto() { document.getElementById('expense-photo').value = ""; document.getElementById('photo-preview-container').classList.add('hidden'); currentPhotoBase64 = null; }
        function addExpense() {
            const item = document.getElementById('expense-item').value; const amountStr = document.getElementById('calc-result-jpy').innerText; const amount = parseInt(amountStr) || 0; const isAdvance = document.getElementById('expense-is-advance').checked;
            if (!item || amount <= 0) { alert("請輸入項目和金額喔！🥺"); return; }
            expenses.unshift({ id: Date.now(), item: item, amount: amount, image: currentPhotoBase64, date: new Date().toLocaleDateString(), isAdvance: isAdvance });
            localStorage.setItem('expenses_book_2025_v13', JSON.stringify(expenses)); renderExpenses(); updateSplitCalc();
            document.getElementById('expense-item').value = ""; document.getElementById('calc-input').value = ""; document.getElementById('calc-result-jpy').innerText = "0"; document.getElementById('calc-result-twd').innerText = "0"; document.getElementById('expense-is-advance').checked = false; clearPhoto();
        }
        function updateSplitCalc() {
            const travelerCount = parseInt(document.getElementById('traveler-count').value) || 2; localStorage.setItem('traveler_count_v11', travelerCount);
            let totalAdvance = 0; expenses.forEach(ex => { if(ex.isAdvance) totalAdvance += ex.amount; });
            const perPerson = Math.round(totalAdvance / travelerCount);
            document.getElementById('advance-total').innerText = totalAdvance.toLocaleString(); document.getElementById('split-result').innerText = perPerson.toLocaleString();
        }
        function renderExpenses() {
            const container = document.getElementById('expense-container'); const totalEl = document.getElementById('total-jpy'); container.innerHTML = ''; let total = 0;
            const grouped = {}; expenses.forEach((ex) => { total += ex.amount; if (!grouped[ex.date]) grouped[ex.date] = []; grouped[ex.date].push(ex); });
            for (const [date, items] of Object.entries(grouped)) {
                const groupDiv = document.createElement('div');
                groupDiv.innerHTML = `<div class="sticky top-0 bg-kawaii-base/95 backdrop-blur z-10 py-2 mb-2 border-b border-gray-100 flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-kawaii-accent"></span><h4 class="font-black text-gray-500 text-sm">${date}</h4></div>`;
                const listUl = document.createElement('ul'); listUl.className = "space-y-3";
                items.forEach((ex) => {
                    const originalIndex = expenses.findIndex(e => e.id === ex.id);
                    const li = document.createElement('li'); li.className = "bg-white p-3 rounded-2xl flex items-center gap-3 shadow-card border border-gray-50";
                    const advanceTag = ex.isAdvance ? `<span class="bg-kawaii-secondary/20 text-kawaii-secondary text-[10px] px-1.5 py-0.5 rounded-md mr-1 font-black">[代墊]</span>` : '';
                    li.innerHTML = `<div class="w-10 h-10 rounded-xl overflow-hidden bg-gray-100 flex-shrink-0 flex items-center justify-center">${ex.image ? `<img src="${ex.image}" class="w-full h-full object-cover">` : `<i class="fas fa-shopping-basket text-gray-300"></i>`}</div><div class="flex-1 min-w-0"><div class="flex justify-between items-baseline"><h4 class="text-sm font-bold text-gray-700 truncate">${advanceTag}${ex.item}</h4><span class="font-black text-sm text-kawaii-text">¥${ex.amount.toLocaleString()}</span></div></div><button onclick="deleteExpense(${originalIndex})" class="w-8 h-8 rounded-full bg-red-50 text-red-300 hover:bg-red-100 flex items-center justify-center transition-colors"><i class="fas fa-trash-alt text-xs"></i></button>`;
                    listUl.appendChild(li);
                });
                groupDiv.appendChild(listUl); container.appendChild(groupDiv);
            }
            totalEl.innerText = total.toLocaleString(); updateSplitCalc();
        }
        function deleteExpense(index) { if (confirm("要刪除這筆紀錄嗎？")) { expenses.splice(index, 1); localStorage.setItem('expenses_book_2025_v13', JSON.stringify(expenses)); renderExpenses(); } }
        function clearExpenses() { if (confirm("確定要清空所有紀錄嗎？")) { expenses = []; localStorage.setItem('expenses_book_2025_v13', JSON.stringify(expenses)); renderExpenses(); } }
        function renderTodoList() {
            const container = document.getElementById('checklist-container'); container.innerHTML = '';
            todoList.forEach((todo, index) => {
                const div = document.createElement('div'); div.className = "flex items-center gap-3 p-2 hover:bg-gray-50 rounded-lg transition-colors group";
                div.innerHTML = `<div class="relative flex items-center justify-center w-5 h-5"><input type="checkbox" class="peer appearance-none w-5 h-5 border-2 border-gray-300 rounded-md checked:bg-kawaii-green checked:border-kawaii-green transition-colors cursor-pointer" ${todo.done ? 'checked' : ''} onchange="toggleTodo(${index})"><i class="fas fa-check text-white text-xs absolute pointer-events-none opacity-0 peer-checked:opacity-100 transition-opacity"></i></div><span class="text-sm font-bold text-gray-600 flex-1 ${todo.done ? 'line-through text-gray-300' : ''}">${todo.text}</span><button onclick="removeTodo(${index})" class="text-gray-200 hover:text-red-400 opacity-0 group-hover:opacity-100 transition-opacity"><i class="fas fa-times"></i></button>`;
                container.appendChild(div);
            });
        }
        function toggleTodo(index) { todoList[index].done = !todoList[index].done; saveTodo(); }
        function addTodo() { const input = document.getElementById('new-todo'); const text = input.value.trim(); if (text) { todoList.push({ text: text, done: false }); saveTodo(); input.value = ''; } }
        function removeTodo(index) { todoList.splice(index, 1); saveTodo(); }
        function saveTodo() { localStorage.setItem('todo_book_2025_v7', JSON.stringify(todoList)); renderTodoList(); }

        const GAS_URL = "https://script.google.com/macros/s/AKfycbynC94_BpKWXOL9379FVXkTwfx147C7f6p6XdJcLYDZJhxAUlNqKzum7Zr8q7BA-Dag/exec";

        async function syncToCloud() {
            const status = document.getElementById('sync-status');
            const btn = document.getElementById('btn-upload');
            const myId = getDeviceId();
            
            if (!navigator.onLine) { alert("目前沒有網路，無法備份喔！☔"); return; }
            if(expenses.length === 0 && !confirm("目前的紀錄是空的，確定要覆蓋雲端資料嗎？")) return;

            try {
                status.innerText = "正在上傳資料到雲端... ☁️";
                btn.disabled = true;
                btn.classList.add('opacity-50');

                const response = await fetch(GAS_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { "Content-Type": "text/plain;charset=utf-8" },
                    body: JSON.stringify({ 
                        deviceId: myId, 
                        expenses: expenses 
                    })
                });
                
                status.innerText = "✅ 備份請求已發送 (請稍後檢查)";
                setTimeout(() => status.innerText = "", 3000);

            } catch (error) {
                console.error(error);
                status.innerText = "❌ 上傳失敗";
                alert("上傳失敗，請檢查網路連線。");
            } finally {
                btn.disabled = false;
                btn.classList.remove('opacity-50');
            }
        }

        async function syncFromCloud() {
            const status = document.getElementById('sync-status');
            const btn = document.getElementById('btn-download');
            const myId = getDeviceId();

            if (!navigator.onLine) { alert("沒有網路無法下載喔！"); return; }
            if (!confirm("確定要從雲端還原嗎？\n⚠️ 這將會覆蓋掉目前手機上的紀錄！")) return;

            try {
                status.innerText = "正在下載雲端資料... 📥";
                btn.disabled = true;
                btn.classList.add('opacity-50');

                const response = await fetch(`${GAS_URL}?deviceId=${myId}`);
                const data = await response.json();

                if (Array.isArray(data)) {
                    expenses = data;
                    localStorage.setItem('expenses_book_2025_v13', JSON.stringify(expenses));
                    renderExpenses();
                    updateSplitCalc();
                    status.innerText = "✅ 還原成功！";
                } else {
                    throw new Error("Data format error");
                }
                setTimeout(() => status.innerText = "", 3000);

            } catch (error) {
                console.error(error);
                status.innerText = "❌ 下載失敗";
                alert("讀取失敗，可能是雲端還沒有您的備份資料喔！");
            } finally {
                btn.disabled = false;
                btn.classList.remove('opacity-50');
            }
        }

        window.addEventListener('online', () => {
            document.getElementById('sync-status').innerText = "網路已連線 📶";
            setTimeout(() => document.getElementById('sync-status').innerText = "", 2000);
        });
    </script>
</body>
</html>